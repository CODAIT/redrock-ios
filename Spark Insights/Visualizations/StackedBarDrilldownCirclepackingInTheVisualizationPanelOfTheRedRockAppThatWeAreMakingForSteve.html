<!DOCTYPE html>
<meta charset="utf-8">
    <style>
        
        /* DRILLDOWN CIRCLEPACKING BY RAPH */
        
        *{
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
    
    .node {
        cursor: pointer;
        -webkit-transition: all 0.3s ease-in-out;
        -moz-transition: all 0.3s ease-in-out;
        -o-transition: all 0.3s ease-in-out;
        transition: all 0.3s ease-in-out;
    }
    
    //.node:hover {
        stroke: #c8d2d2;
        stroke-width: 6px;
        stroke-location: outisde;
        //stroke-dasharray : 6px, 18px;
        //stroke-linecap : round;
        
    }
    
    .node--leaf {
        fill: white;
    }
    
    .label {
        font: 10px "Helvetica Neue", Helvetica, Arial, sans-serif;
        text-anchor: middle;
        fill: #ffffff;
        
        
        
        /*text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;*/
    }
    
    .label,
    .node--root,
    .node--leaf {
        pointer-events: none;
    }
    
    ruler { visibility: hidden; white-space: nowrap; }
    
        </style>
    <body>
        <span id="ruler"></span>
        <p id="test"></p>
        <p id="test2"></p>
        <p id="width"></p>
        <p id="height"></p>
        <p id="shrink"></p>
        <script src="d3.min.js" charset="utf-8"></script>
        <script>
            
            String.prototype.visualLength = function()
            {
                var ruler = $("ruler");
                ruler.innerHTML = this;
                var myOffsetWidth = ruler.offsetWidth;
                ruler.innerHTML = "";
                return myOffsetWidth;
            }
        
        function $(id)
        {
            return document.getElementById(id);
        }
        
        String.prototype.trimToPx = function(length)
        {
            var tmp = this;
            var trimmed = this;
            if (tmp.visualLength() > length)
            {
                trimmed += "...";
                while (trimmed.visualLength() > length)
                {
                    tmp = tmp.substring(0, tmp.length-1);
                    trimmed = tmp + "...";
                }
            }
            return trimmed;
        }
        
        var parentColor = d3.scale.ordinal().range(["1", "2", "3"]);
        
        var color1 = d3.scale.ordinal().range(["#4278bc","#325c80","#264a60","#1c3648","#142834"]);
        
        var color2 = d3.scale.ordinal().range(["#855ca6","#734098","#552f72","#402255","#301940"]);
        
        var color3 = d3.scale.ordinal().range(["#d54326","#a53724","#872b1a","#6c120f","#40130f"]);
        
        
        function returnColor(parentColor, number){
            
            if(parentColor == "1"){
                return color1(number);
            }
            else if(parentColor == "2"){
                return color2(number);
            }
            else if(parentColor == "3"){
                return color3(number);
            }
            else{
                return "#7C1C58";
            }
        }

function renderChart(data, w, h){

    var canvasWidth = w
    var canvasHeight = h

    var margin = 0,
    diameter = 600;
    
    //var optimizedWidth = 1024
    //var optimizedHeight = 624
    
    //var shrinkConstant = w/optimizedWidth

//var ruler = document.getElementById("ruler");
//var width = document.getElementById("width");
//width.innerHTML = w
//var height = document.getElementById("height");
//height.innerHTML = h
//var shrinkLabel = document.getElementById("shrink");
//shrinkLabel.innerHTML = shrinkConstant

    var xPadding = 0
    var yPadding = 0
    var resizeConstant = 0.80
    var canvasHeightAddition = 0

    if( w > 1000) // we want to pad it on the left
    {
        xPadding = 200
        yPadding = 10
    }
    else
    {
        xPadding = 150
        yPadding = 100
        canvasHeightAddition = 100
    }

    w = resizeConstant * w
    h = resizeConstant * h

    var zoomedInSize = 0.88
    var zoomedOutSize = 0.33

    zoomedInSize = resizeConstant * zoomedInSize
    zoomedOutSize = resizeConstant * zoomedOutSize

    diameter = resizeConstant * diameter

    //var svgContainer = d3.select("body").append("svg").attr("width", w).attr("height", h).style("border", "1px solid black"); // for a visual check of the borders

    var svg = d3.select("body").append("svg")
    .attr("width", canvasWidth)
    .attr("height", canvasHeight+canvasHeightAddition)
    .append("g")
    .attr("transform", "translate(" + ((diameter / 2)+100+xPadding) + "," + ((diameter / 2)-25+yPadding) + ")");

    var pack = d3.layout.pack()
    .padding(10)
    .size([diameter - margin, diameter - margin])
    .value(function(d) { return d.size; });


  var root = JSON.parse(data);

  var focus = root,
      nodes = pack.nodes(root),
      view;

  svg.selectAll("circle,text").remove();

  var circle = svg.selectAll("circle")
      .data(nodes)
    .enter().append("circle")
      .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
      .style("fill", function(d) { if(d.depth>=2){ return d.parent ? returnColor(parentColor(d.parent.name),d.size) : null; }else{return "rgba(0,0,0,0)"}})
      .on("click", function(d) { if (focus !== d && focus == root) zoom(d, false), d3.event.stopPropagation(), resize(d); });

  var text = svg.selectAll("text")
      .data(nodes)
      .enter();

  var appendedText = text.append("text");
      appendedText.attr("class", "label")
      .attr("dy","0.4em")
      //.attr("opacity",(toggle)?0:1)
      .style("text-anchor", "middle")
      .style("fill-opacity", function(d) { return 0.5;})
      .style("display", function(d) { return 1;})
      .style("font-size", function(d){

        //this initializes
        return determineFontSizeBasedOnRadiusAndText(d.r, d.name, (d.r*zoomedOutSize) )+"px";
      })
      .text(function(d) { if(d.depth>=2){ return (d.name);}else{return " ";} });

  var node = svg.selectAll("circle,text");

  node.filter(function(d) { return !d.children;}).append("text");

  d3.select("body")
      .style("background", "#FFF")
      .on("click", function() { zoom(root, true); });

  zoomTo([root.x, root.y, root.r * 2 + margin], false);

  function resize(root){
    var focus0 = focus; focus = root;
    //alert("zooming in click")

    /*
    appendedText
    .filter(function(root){return root.parent === focus;})
    .style("font-size", function(d){

      return determineFontSizeBasedOnRadiusAndText(d.r, d.name, (d.r*zoomedInSize) )+"px";
  });
  */
  }

  function hideThenShow(){
    appendedText.style("fill-opacity", 0);
    setTimeout(function(){
      appendedText.style("fill-opacity", 0.6);
    }, 0.4*1000);
  }

  function zoom(d, zoomingOutMa) {
    //if(zoomingOutMa){alert("We are zooming out.")}else{alert("We are zooming in.")}

    var focus0 = focus; focus = d;

    /*
    var transition = d3.transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .tween("zoom", function(d) {
          var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2.3 + margin]);
          return function(t) { zoomTo(i(t), zoomingOutMa); };
        });


        hideThenShow();

    //Handle on click event
    svg.on("click",function(){
      var coordinates = d3.mouse(this);
      // this is the one that zooms out on user click

      //alert("zooming out click line 269")

      appendedText
      .filter(function(root){return root.parent === focus;})
      .style("font-size", function(d){
        // this happens at the wrong time?
        return determineFontSizeBasedOnRadiusAndText(d.r, d.name, (d.r*zoomedOutSize) )+"px";
        //return Math.round(d.r*zoomedOutSize)+"px"
      });

    })*/
  }

  function zoomTo(v, zoomingOutMa) {
    var k = diameter / v[2]; view = v;
    node.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
    circle.attr("r", function(d) { if(d.depth==1){ return (d.r * k)+3; } else{ return d.r * k; } });

    if(!zoomingOutMa){
      appendedText
      .filter(function(root){return root.parent === focus;})
      .style("font-size", function(d){
        return determineFontSizeBasedOnRadiusAndText((d.r*k), d.name, (d.r*k) )+"px";
      });
    }

  }

  function determineFontSizeBasedOnRadiusAndText(radius, text, testSize){
    //var len = text.visualLength();

    ruler.style.fontSize = (testSize)+"px";
    //test.style.fontSize = (testSize)+"px";

    if(text.visualLength() > ((radius*2) * 0.90) ){ //it's too big, overflowing bounds
      //window.alert("The given text... " + text + "... at the font size of... " + testSize + "... is... " + text.visualLength() + " pixels long. The diameter of the circle is " + 2*radius + ". I predict the text will overflow.");
      testSize = testSize * ((radius*2) / text.visualLength() ) * 0.70; // it was too big, so make it smaller
    }
    else if(text.visualLength() < (radius) ) { //it's too small, less than half the diameter
      //window.alert("The given text... " + text + "... at the font size of... " + testSize + "... is... " + text.visualLength() + " pixels long. The diameter of the circle is " + 2*radius + ". I predict the text is too small.");
      testSize = testSize * 1.5 ; //make it a little bigger
    }

    //document.getElementById("test").innerHTML = "size of the string in pixels is... " + len;

    return testSize;
  }

};

function heyRenderThisDataBro(){
    var data7 = '{"name": " ","children": [{"name": "101", "children": [{"name": "beck/arnley", "size":94},{"name": "ngk", "size":169},{"name": "plug", "size":3663},{"name": "acdelco", "size":246},{"name": "he76", "size":80},{"name": "platinum", "size":880},{"name": "(8034)", "size":80},{"name": "iridium", "size":51},{"name": "airtex", "size":90},{"name": "ignition", "size":265}]},{"name": "108", "children": [{"name": "@itsjaun", "size":284}]},{"name": "11", "children": [{"name": "wires", "size":245},{"name": "plugs", "size":395}]},{"name": "121", "children": [{"name": "conventional", "size":211}]},{"name": "127", "children": [{"name": "flame", "size":725}]},{"name": "2", "children": [{"name": "crib", "size":214},{"name": "blunt", "size":1341}]},{"name": "29", "children": [{"name": "ignited", "size":111}]},{"name": "37", "children": [{"name": "denso", "size":3333}]},{"name": "7", "children": [{"name": "convo", "size":915}]}]}';var w = 671.0; var h = 540.0;  renderChart(data7, w, h);
};

</script>
